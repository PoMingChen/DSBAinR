---
title: "HW_PCA"
author: "PoMingChen"
date: "7/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

請使用2017_financial index_163 comp.csv 兩組資料集合(可於上一單元下載)，依照以下題目及步驟完成此次作業：

#### 注意事項

設置工作路徑，並確定資料集合放置在你的工作路徑：
setwd("你的完整工作路徑名稱")
檔案的編碼皆為UTF-8，讀取檔案時請注意：
### 讀成data.frame
`read.csv('檔案名稱', encoding = 'UTF-8')`
### 讀成tibble
`read_csv('檔案名稱', locale= locale(encoding='UTF-8'))`
為了避免程式中的隨機效果造成答案不一致，請將隨機種子設置為500：
`set.seed(500)`

```{r}
library(tidyverse)
library(magrittr)
library(reshape2)
library(nsprcomp)
set.seed(500)
```


```{r}
read_csv("./2017_financial%20index_163%20comp.csv", 
          locale = locale(encoding = "UTF-8")) -> financial.data2

financial.data2 %>% colnames()
```


## 題目一

在這個題目中，我們會進行一些簡單的資料轉換，雖然這些方法很簡單，但在實務上非常常見，建議大家了解一些技巧

根據定義，
`ROA = Net Income / Total Assets`，
`Assets Turnover = Net Sales / Total Assets`，因此你可以透過 ROA / Assets Turnover 得到「淨收益佔淨銷售的比率」。請在你原先的資料集合中加入這個變數，並稱為「sales_margin_rate」。

```{r 小題一新增變數}
#sales_margin_rate = roa/asstes turnover rate = 淨收益佔淨銷售的比率
financial.data2 %>% mutate(sales_margin_rate = roa/asset_turnover) -> financial.data2
```

__假設明年的 ROA 與今年的 ROA 一樣，而且明年的資產成長率與今年一樣__，那麼明年公司會賺的淨利可以用「ROA x (1+資產成長率)」當作指標。請在你原先中的集合加入「ROA x (1+資產成長率)」，並稱為「profit_indicator」。

```{r 小題一新增變數}
financial.data2 %<>%  mutate(profit_indicator = roa*(1+asset_growth_rate))
financial.data2
```

- 請繪製 ROA 變數的直方圖
```{r 小題三ROA變數直方圖}
#直方圖，for continuous_x_variable
ggplot(financial.data2, aes(x=financial.data2$roe))  + geom_histogram(binwidth = 5)
```

- 定義新變數`t_roa = exp(roa/10) / (1+exp(roa/10))`，並繪製直方圖。比較兩者的差別，你發現了什麼？

A: 我發現做了`t_roa`之後，取了exponential，因此所有的roa值都變成正的，同時整個資料的分配狀況也比較smooth。

```{r 第四小題}
financial.data2 %<>% mutate(t_roa = exp(roa/10) / (1+exp(roa/10))) 
```

```{r}
financial.data2 %>% ggplot(data = ., aes(x=financial.data2$t_roa)) + 
  geom_histogram(bidwidth = 5)
```

## 題目二

1. 利用前面新增三個變數的資料集合，進行非負稀疏主成份分析。設定 k 值為 100，`繪製解釋變異數比率圖型`，請問需要多少個主成份才能夠解釋超過七成的變異？

Answer: PC1~PC7，七個，資料累積變異量0.7241711	

```{r}
nsprcompmodel2 <- financial.data2[, 2:ncol(financial.data2)] %>% 
  nscumcomp(x = ., 
            k=100,
            nneg = T,
            scale. = T) ##PCA is always needed to scale.
```

```{r}
summary(nsprcompmodel2)
```

```{r}
nsprcompmodel2.table <- tibble( ##to build a tibble, use `tibble` not `as_tibble` 
  PC_x = paste0("PC_", formatC(1:19, width = 2, flag="0")),
  variance = (nsprcompmodel2$sdev)^2,
  prop = (nsprcompmodel2$sdev)^2/sum((nsprcompmodel2$sdev)^2),
  cum_prop = cumsum(prop)
)
nsprcompmodel2.table
```

```{r}
nsprcompmodel2.table %>%
  ggplot(data = ., aes(x=nsprcompmodel2.table$PC_x, 
                       y=nsprcompmodel2.table$cum_prop)) +
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
      axis.title = element_blank())
```

2/ 根據上題選出的個數，繪製主成份係數矩陣的熱圖 (heatmap)。第一與第二主成份最重要的影響變數是哪些？

3. 繪製主成份 1 與主成份 2 分數的散佈圖，請在平面上找出一間你認為表現最好的公司，在網路上搜尋他今年3月20至4月20的股票表現。




