---
title: "Lecture_Regression"
author: "PoMingChen"
date: "8/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## EDA

```{r}
library(tidyverse)
library(knitr)

SalesData <- read_csv('./Restaurant_Sales.csv')

head( SalesData[1:10,], row.names = F, caption = '原始資料')
```

基本變數資料：

- Store_Name： 店別
- Region：所在區域，A為觀光區，B為商業區
- Type： 門市類型，AA為百貨門市，BB為獨立門市
- Day_Type：日別
- Month：月份

然後每間店都是過去一年的營收資料，共有365*4=1460 rows.

> 以下的EDA都只是以各個變數（Region Type Weekday Month）不斷去做視覺化觀察，觀察其箱型圖分配。

### 各店的銷售分配

我們可以看到，店一店四，是營收中位數比較高的兩間店。()

- 店一：A為觀光區｜AA為百貨門市
- 店二：B為商業區｜AA為百貨門市
- 店三：B為商業區｜BB為獨立門市
- 店四：A為觀光區｜BB為獨立門市

```{r}
# SalesData %>% class()
SalesData$Store_Name <- as.factor(SalesData$Store_Name)

SalesData %>%
  filter(Store_Name %in% 4)

ggplot(data = SalesData) + geom_boxplot(aes( x= Store_Name, y= Sales, colour = Store_Name)) + 
  labs( x = 'Store',
        y = 'Sales',
        title = 'Sales Distribution by Store')
```

#### 各區域的銷售分配

以區域Region來分，那麼1 4會一組。2 3會一組。

- 店一：A為觀光區｜AA為百貨門市
- 店二：B為商業區｜AA為百貨門市
- 店三：B為商業區｜BB為獨立門市
- 店四：A為觀光區｜BB為獨立門市

很明顯的， __A觀光區__的營收中位數比較高。

```{r}
ggplot(data = SalesData) + geom_boxplot(aes( x = Region, y = Sales,colour = Region)) + 
  labs( x = 'Region',
        y = 'Sales',
        title = 'Sales Distribution by Region')
```

#### 各門市類型的銷售分配

以門市類型Type來分，那麼 1 2會一組，3 4會一組。

很明顯的， __AA為百貨門市__的營收中位數比較高。

```{r}
ggplot(data = SalesData) + geom_boxplot(aes( x = Type, y = Sales, colour = Type)) + 
  labs( x = 'Type',
        y = 'Sales',
        title = 'Sales Distribution by Type')
```

#### 各店間的平假日銷售分配

四間店平日和假日的銷售分佈不盡相同，店三的狀況比較特別。

- 店一：A為觀光區｜AA為百貨門市｜假日比平日高
- 店二：B為商業區｜AA為百貨門市｜假日比平日高
- 店三：B為商業區｜BB為獨立門市｜假日比平日低
- 店四：A為觀光區｜BB為獨立門市｜假日比平日高

```{r}
ggplot(data = SalesData) + geom_boxplot(aes( x = Weekday, y = Sales, colour = Weekday)) + 
  facet_grid(. ~ Store_Name) + ##  這邊～ 前後有沒有“.” 不影響。然後facet_wrap，會把subplot用成長方形排版，但是我覺得比不上col. 分割做比較。
  labs( x = 'Weekday',
        y = 'Sales',
        title = 'Sales Distribution by Weekday') 
```

#### 各店間的月份銷售分配

四間店在各月份的銷售分佈也不盡相同

```{r}
SalesData$Month <- factor(SalesData$Month, levels = c('Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'))

SalesDatabyMonth <- SalesData %>% 
  group_by(Store_Name, Month) %>%
  summarise(SalesMean = mean(Sales))

SalesDatabyMonth


#補充：geom_path: Each group consists of only one observation. Do you need to adjust the group aesthetic?
#參考資料：x 軸( period ) 是一個`因子`而不是數值，因此它不會連接它們。 你可以通過在美學（aes, geomLine，確實有group這個aes)中，設置 group = 1 來修復這個問題，這告訴ggplot2將它們組合成一行。
ggplot(data = SalesDatabyMonth, aes(x = Month, y = SalesMean, group = 1)) + geom_point() + geom_line() +
  facet_grid(.~Store_Name) + ## 變數擺在~左邊，是for row. 反之右邊是for col.
  labs( x = 'Month',
        y = 'Sales',
        title = 'Sales Distribution by Month') 
```

## Regression

迴歸分析主要會用到的函數是`lm()`，意思是Linear Model。主要使用到的參數有兩個：

`formula: Y ~ X1 + X2`，Y是反應變數，X1和X2是解釋變數。
data: 要分析的資料集合名稱。
__這個類型的物件裡面包含很多內容，用來描述模型的細節。如果要呼叫摘要__，一樣使用`summary()`。

### 驗證假說*4

> 剛才我們看了四個變數的資料視覺化，Region Type算是比較有顯著區別的變數，Type裡面是店三趨勢比較不同。因此接下來要用迴歸模型來驗證假說。


### 依區域分開建模

由於我們發現區域(Region)之間的營業額有較明顯的差異，但在其他變數中營業額的分布各有不同，因此我們先依照區域切分資料，探討其他變數的影響。 __或者你可以想成最基本的立足點相同。__

```{r}
DataA <- SalesData %>%
  filter( Region %in% 'A') ##A為觀光區
DataB <- SalesData %>%
  filter( Region %in% 'B') ##B為商業區
```

#### 驗證假說一：門市類型的差異
```{r}
Model.A.Type <- lm( Sales ~ Type, data = DataA)
Model.B.Type <- lm( Sales ~ Type, data = DataB)
```

對於這兩個區域而言， __門市類型的差異有非常顯著的影響（係數顯著程度***，且區域A係數為-22486，區域B係數為-5836），R-squared分別是0.72和0.46，具有相當不錯的解釋能力。__
```{r}
summary(Model.A.Type)
```

```{r}
summary(Model.B.Type)
```

#### 驗證假說二：假日的差異
```{r}
Model.A.Week <- lm( Sales ~ Weekday, data = DataA)
Model.B.Week <- lm( Sales ~ Weekday, data = DataB)
```

平日假日對於區域A而言雖有顯著的差異(`t-test` ***)，但對整體營收變化的解釋力較弱(`r^2`比較小)
；對於區域B而言，並沒有顯著的差異及影響。
```{r}
summary(Model.A.Week)
```

```{r}
summary(Model.B.Week)
```

#### 驗證假說三：月份的差異

區域A間的區域B間的月份間皆有顯著的差異，但各月份的影響程度不一；對於區域B而言，月份對整體營收的變化有較好的解釋能力。
```{r}
Model.A.Month <- lm( Sales ~ Month, data = DataA)
Model.B.Month <- lm( Sales ~ Month, data = DataB)
```

區域A間的區域B間的月份間(t-test)皆有顯著的差異，但各月份的影響程度不一；對於區域B而言，月份對整體營收的變化有較好的解釋能力。(F-test有過，Model.A.Month的p-value：0.07117，頂多過10%的假設檢定)
```{r}
summary(Model.A.Month)
```

```{r}
summary(Model.B.Month)
```

## 納入上述顯著變數並檢視目前模型的解釋能力 

目前已經比較完成了驗證假說（Type, Weekday, Month）的部分

Type對A B區很顯著。

Weekday對B區不顯著，不放。

Month對A區影響力比較小，但是還算勉強，B區沒問題。

```{r}
Model.A <- lm( Sales ~ Type + Weekday + Month, data = DataA)
Model.B <- lm( Sales ~ Type + Month, data = DataB)
```

完成第一階段的模型建立
```{r}
summary(Model.A) ##解釋力0.8432
```

```{r}
summary(Model.B) ##解釋力0.5438
```

### 用視覺化圖表來檢視目前的成果

- 店一的營收

```{r}
Model.A$residuals #殘差值（之後估計模型誤差狀況會遇到）
Model.A$fitted.values #估計值
# Model.A$effects
```

以目前的迴歸模型，並沒有辦法預測到，比較極端的點。還有改善空間。若我們偷吃步用之後才會用到的`MAPE`，你會發現目前模型的可能的誤差高達25.5%
```{r}
#DataA[1:365,] ##for 店一
#用兩個圖層，將估計值與原始資料（可以理解為training set）的預測狀況疊在一起做個比較。

ggplot(data = DataA[1:365,]) + 
  geom_point(aes(x = c(1:365), y = Sales)) + 
  geom_line(aes( x = c(1:365), #geom_line 主要是用來繪製時間趨勢圖（流量），那如果是geom_area，就是看底下陰影面積狀況（存量）
                 y = Model.A$fitted.values[1:365],
                 colour = 'red')) +
  labs( x = 'Day1 to Day365',
        y = 'Sales',
        title = 'Store1 Sales: Actual vs Predicted')
```

```{r}
MAPE <- function( predict, actual){
  result <- mean(abs((predict - actual)/actual)) %>% round(3) * 100
  return(result)
}

cat('RegionA模型的MAPE：\n',MAPE(Model.A$fitted.values, DataA$Sales[1:365]),'%','\n',sep='')
```

